# HBV MUTATIONAL ANALYSIS

## BACKGROUND

This method has been developed to carry out the screening of mutations on FASTA files obtained from Sanger sequencing of hepatitis B virus (HBV) samples received by the Blood Borne Virus unit (BBVU). 

Consensus nucleotide sequences generated by PCR amplification of two different regions:

- **sp amplicon**, covering a region between nucleotides 892 and 1906 (*numbering AY128092.1 Polymerase*), 
- **xc amplicon**, covering a region between nucleotides 1656 and 2402 (*numbering AY128092.1 complete genome*), 

are used for the analysis of substitutions in the protein Surface and Polymerase (RT domain) and in the protein X and Precore, respectively.

The script takes FASTA files containing the consensus nucleotides sequences and a CSV file consisting of a sample list with the genotypes for the samples (if available) and performs **pair alignments** between each sequence and a specific reference sequence provided. The sequences from ***xc amplicons*** are aligned to the reference sequence [LC360507.1_WG_xprecore.fas](refseqs/LC360507.1_WG_xprecore.fas) whereas the ones generated from ***sp amplicons*** are aligned to the corresponding reference sequence ([*"_polymerase_surface"* found in directory refseqs](refseqs)), depending of the genotype indicated for that sequence in the CSV file. 

An initial nucleotide alignment is used to **trim the sequences at the lenght of the region of interest** (X region, Precore, Polymerase-RT or Surface). Then, the sequences are analysed for **potential frame-shifts**. As the initial alignment is trimmed using the coordinates for the reference sequence, this one should be in frame after removing any gap from the nucleotide sequence. Three different frames are evaluated for the consensus sequence after removing any gaps, then aligned to the trimmed ungapped reference sequence and the resulting alignment is scored for similarities. If the first frame of the consensus sequence gets the higher score, the alignment goes through the analysis of mutations. Otherwise the sequence is reported as frame-shifted and no further analysis is performed.  

A **codon alignment** is carried out in a next step. Gaps in the nucleotide alignment are removed and the resulting alignment is translated to amino acids and aligned. The protein alignment is then used to *translate the nucleotide nucleotides back*. Each *amino acid* from the protein alignment corresponds to a *codon* from the ungapped nucleotide alignment, therefore every position in the amino acid alignment matches three positions in a nucleotide sequence. In addition, *gaps (-)* in the protein alignment should be equivalent to a *triplet of hyphens (---)*. These principles are used to re-organise the nucleotide sequences into a new nucleotide alignment.

The codons from the new nucleotide alignment are **translated to amino acids** and they are stored in a list, keeping the exact order they have in the alignment. A second list is used to store the amino acids of the reference and the consensus sequences. The two lists are used to explore potential **insertions** in the *consensus* sequence, which are detected by the presence of the notation **"---"** at any codon of the *reference* sequence. The amino acid involved in the insertion and the position are annotated and them removed from the list as well as the codon contributing to the insertions. In this way, the numbering for the codons and amino acids in the lists are the same as the reference sequence used for the alignment. 

In a final step, the corrected list of codons and amino acids are used to **scan for variations** between the *reference* sequence and the *consensus* sequence. Any change that differs from the reference sequence or from [substitutions considered as common on HBV strains](Amino%20Acid%20Templates%20BBVU) are annotated.

All the changes found are then recorded in a excel file that the user can explore. 

## REQUIREMENT
The main packages and Python libraries used for this method are:
- Python 3.6.1
- Biopython 1.78
- Pandas 1.1.5
- Openpyxl 3.0.9
- Clustalw 2.1

The easiest way of installing these software packages and other additional dependencies is by means of using [Anaconda distribution](https://www.anaconda.com/products/individual). Visit https://docs.anaconda.com/anaconda/install/ for installation details. 

With [git](https://git-scm.com/) and Anaconda already installed in the computer, enter the following command in your terminal:

`git clone https://github.com/juanledesma78/hbv_mutational_analysis.git`

A new directory called **hbv_mutational_analysis**, containing all the files from the repository, is created in the working directory where the command lines have been executed. A file called [**environment.yml**](environment.yml), which contains the list of all the software and dependencies needed, should be found in the recently created directory. This file can be used to create a new environment called **hbv_mutations** in Anaconda. Before creating the environment, replace the line */home/phe.gov.uk/juan.ledesma/miniconda3/* in the *prefix* of the yml file with the path to where conda is installed on your computer. A simple way to get that path is typing in a terminal:

```conda env list```

which will return the path to base or where conda is located 
```
# conda environments:
#
base                  *  /home/phe.gov.uk/another.user/miniconda3

```
Once the prefix has been modified (i.e.*prefix: /home/phe.gov.uk/another.user/miniconda3/envs/hbv_mutations*), use the following command to create the new environment with all the software listed in the YML file

`
conda env create -f environment.yml
`

## USAGE

While the whole repository includes several folders and files, the ones **required** to make the method work are:

- [**refseqs**](refseqs), which contains the FASTA files with the nucleotides sequences of the reference strains for the analysis of polymerase and surface for 10 genotypes (A-J) and a single reference for the analysis of Precore and X region. These files are used to align the consensus sequences provided from the runs so the variation between consensus and reference sequences can be evaluated.    

  * AY128092.1_Genotype_A_polymerase_surface.fas
  * AY167089.1_Genotype_B_polymerase_surface.fas
  * KM999990.1_Genotype_C_polymerase_surface.fas
  * X65257.1_Genotype_D_polymerase_surface.fas
  * X75657.1_Genotype_E_polymerase_surface.fas
  * KX264497.1_Genotype_F_polymerase_surface.fas
  * AF160501.1_Genotype_G_polymerase_surface.fas
  * AY090457.1_Genotype_H_polymerase_surface.fas
  * AF241411.1_Genotype_I_polymerase_surface.fas
  * AB486012.1_Genotype_J_polymerase_surface.fas
  * LC360507.1_WG_xprecore.fas

- [**Sample_list.csv**](Sample_list.csv), an empty CSV file containing the headers *Seq ID*	and *Genotype*,

- [**hbv_mutational_analysis.py**](hbv_mutational_analysis.py), the script to run the analysis,

- [**mutation_utilities.py**](mutation_utilities.py), a module with functions used in script,

These files and folder should be transferred to the directory **BBVU/HBV Routine Sequencing** where all the Sequencing runs are stored, so the script **hbv_mutational_analysis.py** has direct access to the run folders (i.e. 2022 Sequencing Data/Jan 2022/E1673). 

The ***INPUTS*** the method uses to perform the mutational analysis are: 

- **FASTA files**, which **must** be stored in a subdirectory called **Consensus** within the run directory (i.e E1647/Consensus). These FASTA files contain nucleotide sequences generated by the sequencing of the PCR **sp** and **xc** amplicons, described above. The identifiers or FASTA headers **must** be named following the following pattern: ***tubeNo_molisID*** followed by either ***sp*** or ***xc*** depending of the PCR amplicon used to generate the sequence (i.e 01_H12345678sp). Failing to include the amplicon identifier (sp or xc) will stop the analysis. Note that tube number and molis ID are separated by underscore and no other separator should be used. If the user wants to add descriptive information to the FASTA header, underscore (_) should be avoided using instead other characters for this purpose (i.e 03_H214561122-EXTRACTED-USING-MAGNAPURExc).  

- A **Sample_list.csv**. The file **Sample_list.csv** provided with the repository can be used to insert the sample IDs of the sequences to be analysed into the column *Seq ID*. Note that the sample id **must** match the FASTA header after removing ***sp*** or ***xc***. The **digit format** of the label referring the **tube number** in the FASTA header and the sample ID in the CSV file **should** be the same (***01, 02, 10*** most prefereble to 1, 2, 10). If they differ (for example, 01 in FASTA header and 1 in CSV file), the consensus sequences would not be analysed. The same sample list used for the extraction could be used for the column *Seq ID* as long as the IDs follow the same naming rule described above. Be aware that if the last two digits of the molis number referring to the aliquot are excluded from the sample ID in the CSV file, they should be excluded from the FASTA header as well. The information for the genotype should be added to the column *Genotype*. The first character in the row, written in capital letter, **must** correspond to any of the HBV genotypes (A-J) but other comments are allowed after this first one (i.e. F1/F1 or D1 by core, unknown, N/A). Once the CSV file is filled with the information required, it **must** be saved in the same subdirectory **where the FASTA files** are (i.e E1647/Consensus) under the name **Sample_list.csv**. 

Before running the script, the conda environment **MUST** be activated. In a terminal, type 

`conda activate hbv_mutations`


The script **hbv_mutational_analysis.py** takes one argument **-dir** (or just -d), being its value the path to the run to analyse (i.e. *2022 Sequencing Data/Jan 2022/E1673*). To start the analysis of a run, type in the terminal

`python3 /path/to/hbv_mutational_analysis.py -dir /path/to/RunID`


If needed, the user can find help on how to run the script by typing

`python3 /path/to/hbv_mutational_analysis.py --help`


If any error is found during the execution of the script, the terminal will return a message with information about the issue (i.e FASTA sequences without labels xc/sp, no FASTA files found, no CSV file available...). 

A message will be displayed when the analysis is successfully complete pointing to the location where the results have been stored. 

The ***OUTPUTS*** of the method are:

- a **summary log in TXT format** (i.e. *E1647_hbvma_v1.0_log.txt*), which corresponds to a summary of the *inputs*, *outputs* and potential *warnings* of the analysis. It is **strongly recommended** for the user to have a look of it before checking the results, in case some samples were excluded from the analysis due to omission of their Ids in the CSV file, misspelling of Ids in CSV file or FASTA headers...  

- a **error log in TXT format** (i.e. *E1647_hbvma_v1.0_log_ERROR.txt*), only generated when the analysis is stopped due to the absence of the labels *"sp"* or *"xc"* in the FASTA header.  

- a **report in XLSX format** (i.e. *Results_E1647_hbvma_v1.0.xlsx*) that contains a first tab called *All* which includes a list with all the sample IDs and genotypes provided in *Sample_list.csv* alongside the results after analysing the 4 genomic regions. NA is used when a FASTA file is not found in the directory RUNID/Consensus (either becuase that amplicon has not been sequenced or the FASTA file has not been not provided). Ten additional tabs (A-J) are used to record the results according to the genotype of the samples and a final tab called *CORE* records the results available for genes X and Precore. Two final tabs, *Numbering* and *Extended_IUPAC_aa_code*, are used to display the accession numbers for the numbering of the substitution in the results and the symbols to refer the 20 standard amino acids as well as other potential combinations of ambiguous amino acids, respectively.  

- a directory **alignmnets** that contains the alignments between each consensus sequence and the reference sequence used for the analysis of *polymeraseRT*, *surface*, *xregion* and *precore*, information provided in the excel file. The numbering of the substitutions recorded in the report is based on the reference sequence included in each alignmnet. An additional subdirectory called **raw_trimmed** is used to store the initial nucleotide alignments after trimming for the length of the four genomic regions. These alignments are used for the script to check potential frame-shifts in the sequences. Samples with the label *"Sequence NOT in frame"* in any of the genomic regions will find their corresponding alignmnet **ONLY in this subdirectory**, in case the user wants to check the positions involved in the frame-shift.   

## TESTING

Data used for testing and the corresponding results are located in [Testing - 2021 Sequencing Data](Testing%20-%202021%20Sequencing%20Data) and [Testing - 2021 Sequencing Data](Testing%20-%202022%20Sequencing%20Data). 
 
Although the script works with a list of substitutions considered as *"wildtype"* for specific genotypes (see lines 262-328 in [mutation_utilities.py](mutation_utilities.py), i.e, S and N are common amion acids at position 207), any combined substitution generated by ambiguous nucleotides will be recorded in the excel file even if they are in this list (i.e S207N/S), so that the user is always aware of the quasispecies present in the sequence. 

Ambiguous amino acids such as **B** (N/D, Asparagine or Aspartic acid), **Z** (E/Q,	Glutamic acid or Glutamine) or **J** (L/I, Leucine or Isoleucine) may be recorded in the report. The user can check the tab *Extended_IUPAC_aa_code* in the EXCEL for additional information if needed.

The analysis of the Polymerase (RT domain) in the script covers from the first amino acid to amino acid 269 (position 73 to 250 in the manual method) so any change differing from the reference sequence is recorded for this region. The analysis for precore and surface covers the same regions in both methods. 

The script includes **genotypes A-J** so any sample belonging to any of these genotypes can be analysed. 

The performance of the script has been tested for:

- the analysis of mutations in [**genotypes G, J and I**](Testing%20-%202022%20Sequencing%20Data/Miscellaneus/misc/Results_misc_hbvma_v1.0.xlsx)
- detection of **frameshifts**
- detection of the **severals indels** in the sequence [05_H214460979sp](Testing%20-%202022%20Sequencing%20Data/Miscellaneus/misc/Results_misc_hbvma_v1.0.xlsx)
    * deletion of amino acid R at position 18
    * insertion of amino acid R at position 60
    * deletion of amino acids L and S at position 108 and 109 respectively
    * insertion of amino acid P at position 140
- scanning for mutations in [**partial fragments**](Testing%20-%202021%20Sequencing%20Data/September/E1596_partial_sp)
- **numbering** referred to reference sequence
- generation of the **report**
- **exceptions** to handle errors
 
## LIMITATIONS

Although the method includes a tool to find the first amino acid in a sequence (see function first_aa_nt_in_partial_fragment in [mutation_utilities.py](mutation_utilities.py)), the report does not record this. For instance, the report for X region (partial fragment) would record the first substitution of the consensus sequence differing from the reference (if any) but would not inform at which position the amplicon starts. Another example could be polymerase sequences only covering a region below the amino acid 269, due to low quality sequencing resulting in small amplicons. The absence of information between the end of the amplicon and the amino acid 269 could be represented as deletions in the final report. This should be considered for future versions of the tool. 

Clustal does **NOT** deal with **ambiguous amino acids** *(BZJUO)* or *stop codons* (*) when doing **protein alignments** (step needed for **codon alignment**). In the script these characters are replaced with X to allow the alignment of amino acids. Otherwise clustal considers them as gaps and the amino acid sequences could be misaligned. 
Other aligners such as [MAFFT](https://mafft.cbrc.jp/alignment/software/) or [MUSCLE](https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-5-113) may be considered for future versions. 

The method has been developed in a **linux** machine using Ubuntu 18.04. 
For **Windows user**, this version has not been fully tested yet and some of the [software requirements](environment.yml) may need to be installed manually to make the script work.  

## CONTACT DETAILS

Juan Ledesma

VRD Bioinformatics 

UK Health Security Agency

juan.ledesma@phe.gov.uk 

February 2022

